// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  avatar    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  sentMessages     Message[]         @relation("SentMessages")
  chatsAsUser1     Chat[]            @relation("ChatUser1")
  chatsAsUser2     Chat[]            @relation("ChatUser2")
  groupMemberships GroupMember[]
  rooms            Room[]
  blockedUsers     BlockedUser[]     @relation("BlockedBy")
  blockedByUsers   BlockedUser[]     @relation("Blocks")
  messageReactions MessageReaction[]

  @@index([email])
  @@map("users")
}

model Chat {
  id      String  @id @default(uuid())
  userId1 String
  userId2 String?

  user1 User  @relation("ChatUser1", fields: [userId1], references: [id], onDelete: Cascade)
  user2 User? @relation("ChatUser2", fields: [userId2], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages Message[]

  @@index([userId1])
  @@index([userId2])
  @@map("chats")
}

model Message {
  id       String @id @default(cuid())
  content  String
  senderId String

  chatId  String?
  groupId String?

  // Reply functionality
  replyToId String?
  replyTo   Message?  @relation("MessageReplies", fields: [replyToId], references: [id], onDelete: SetNull)
  replies   Message[] @relation("MessageReplies")

  // Delete for everyone
  deletedForEveryone Boolean   @default(false)
  deletedAt          DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sender User   @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  chat   Chat?  @relation(fields: [chatId], references: [id], onDelete: Cascade)
  group  Group? @relation(fields: [groupId], references: [id], onDelete: Cascade)

  // Reactions
  reactions MessageReaction[]

  @@index([chatId, createdAt])
  @@index([groupId, createdAt])
  @@index([senderId])
  @@index([replyToId])
  @@map("messages")
}

model MessageReaction {
  id        String   @id @default(cuid())
  messageId String
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  emoji     String // e.g., "üëç", "‚ù§Ô∏è", "üòÇ"
  createdAt DateTime @default(now())

  @@unique([messageId, userId, emoji])
  @@index([messageId])
  @@map("message_reactions")
}

model Group {
  id        String   @id @default(uuid())
  name      String
  avatar    String?
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members  GroupMember[]
  messages Message[]

  @@map("groups")
}

model GroupMember {
  id       String   @id @default(cuid())
  groupId  String
  group    Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  userId   String
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  joinedAt DateTime @default(now())

  @@unique([groupId, userId])
  @@map("group_members")
}

model Room {
  id        String   @id @default(uuid())
  name      String   @unique
  topic     String?
  createdBy String
  creator   User     @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("rooms")
}

model BlockedUser {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation("Blocks", fields: [userId], references: [id], onDelete: Cascade)
  blockedId String
  blocked   User     @relation("BlockedBy", fields: [blockedId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, blockedId])
  @@map("blocked_users")
}
